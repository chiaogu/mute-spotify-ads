<!DOCTYPE html>
<html>

<head>
  <title>Mute Spotify Ads</title>
</head>

<body>
  <div id="app">
    <p>{{ trackName }}</p>
  </div>

  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
  <script>
    (async () => {
      const queryString = new URLSearchParams(location.search);
      const refreshToken = queryString.get('refresh_token');
      if(!refreshToken) return window.location.href = '/api/login';

      function getTrackInfo(state, key) {
        const { track_window: { current_track: currentTrack = {} } = {} } = (state || {});
        return currentTrack[key];
      }

      const vm = new Vue({
        el: '#app',
        data: {
          volume: undefined,
          playerState: null
        },
        computed: {
          isCurrentTrackAd() {
            return getTrackInfo(this.playerState, 'type') === 'ad'
          },
          trackName() {
            return getTrackInfo(this.playerState, 'name');
          },
        }
      });

      async function onTrackTypeChange(type) {
        if(type === 'ad') {
          vm.volume = await player.getVolume();
          await player.setVolume(0);
          console.log('Muted!');
        } else {
          await player.setVolume(vm.volume);
          console.log('Unmuted!');
        }
      }

      async function onPlayerStateChange(state) {
        const previousType = getTrackInfo(vm.playerState, 'type');
        const currentType = getTrackInfo(state, 'type');
        vm.playerState = state;
        if(previousType !== currentType) onTrackTypeChange(currentType);
      }

      await new Promise(resolve => window.onSpotifyWebPlaybackSDKReady = resolve);
      const player = new Spotify.Player({
        name: 'Mute Ads',
        getOAuthToken: async callback => {
          const refreshTokenUrl = `/api/refresh-token?refresh_token=${refreshToken}`;
          const { access_token } = await (await fetch(refreshTokenUrl)).json();
          callback(access_token);
        }
      });
      player.addListener('initialization_error', ({ message }) => { console.error(message); });
      player.addListener('authentication_error', ({ message }) => { console.error(message); });
      player.addListener('account_error', ({ message }) => { console.error(message); });
      player.addListener('playback_error', ({ message }) => { console.error(message); });
      player.addListener('player_state_changed', onPlayerStateChange);

      // Ready
      player.addListener('ready', ({ device_id }) => {
        console.log('Ready with Device ID', device_id);
      });

      // Not Ready
      player.addListener('not_ready', ({ device_id }) => {
        console.log('Device ID has gone offline', device_id);
      });

      // Connect to the player!
      player.connect();
    })();
  </script>
</body>

</html>